<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Darren & Tina 2026</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs (Standard Scripts) -->
    <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --morandi-olive: #6B705C;
            --morandi-beige: #B7B7A4;
            --morandi-gold: #DDB892;
            --bg-light: #F8F7F2;
        }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg-light); color: #4A4E40; -webkit-tap-highlight-color: transparent; }
        .couple-name { font-family: 'Playfair Display', serif; font-size: 2rem; color: #2D3128; }
        .app-card { background: white; border-radius: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 1rem; }
        .bottom-nav { background: rgba(74, 78, 64, 0.95); backdrop-filter: blur(10px); position: fixed; bottom: 20px; left: 15px; right: 15px; border-radius: 2rem; height: 60px; display: flex; justify-content: space-around; align-items: center; z-index: 1000; }
        .nav-btn { font-size: 1.2rem; cursor: pointer; transition: 0.2s; padding: 10px; }
        .hidden { display: none; }
        .active-tab { opacity: 1 !important; transform: scale(1.1); }
        .loading-overlay { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        
        #gemini-modal { position: fixed; inset: 0; z-index: 2000; background: rgba(0,0,0,0.3); visibility: hidden; opacity: 0; transition: 0.3s; }
        #gemini-modal.open { visibility: visible; opacity: 1; }
        #gemini-panel { position: absolute; bottom: 0; left: 0; right: 0; height: 80%; background: #F8F7F2; border-radius: 2rem 2rem 0 0; transform: translateY(100%); transition: 0.3s cubic-bezier(0, 0, 0.2, 1); }
        #gemini-modal.open #gemini-panel { transform: translateY(0); }
    </style>

    <script>
        // ÂÖ®ÂüüËÆäÊï∏ÂÆöÁæ©
        let db, auth, user = null, allExpenses = [];
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'darren-tina-2026';
        const rates = { 'TWD': 1.05, 'USD': 35.5, 'THB': 1 };

        window.onload = async function() {
            try {
                // 1. ÂàùÂßãÂåñ Firebase (Compat ÁâàÊú¨Á¢∫‰øùÂÖ®ÂüüÂ≠òÂèñ)
                const firebaseConfig = JSON.parse(__firebase_config);
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();

                // 2. Ë™çË≠â
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await auth.signInWithCustomToken(__initial_auth_token);
                } else {
                    await auth.signInAnonymously();
                }

                auth.onAuthStateChanged(u => {
                    user = u;
                    if (u) {
                        document.getElementById('loading-screen').style.opacity = '0';
                        setTimeout(() => document.getElementById('loading-screen').classList.add('hidden'), 500);
                        startSync();
                    }
                });

                // 3. Á∂ÅÂÆöÊåâÈàïÂà∞ÂÖ®Âüü (Á¢∫‰øùÈªûÊìäËÉΩÂü∑Ë°å)
                window.switchTab = (id) => {
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                    document.getElementById('content-' + id).classList.remove('hidden');
                    document.querySelectorAll('.nav-btn').forEach(b => b.style.opacity = '0.3');
                    document.getElementById('btn-' + id).style.opacity = '1';
                };

                window.addItinerary = async () => {
                    const act = document.getElementById('it-activity').value;
                    if (!act || !user) return;
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('itinerary').add({
                        day: document.getElementById('it-day').value || 'Day 1',
                        time: document.getElementById('it-time').value || '12:00',
                        activity: act,
                        type: document.getElementById('it-type').value
                    });
                    document.getElementById('it-activity').value = '';
                };

                window.addExpense = async () => {
                    const item = document.getElementById('exp-item').value;
                    const cost = parseFloat(document.getElementById('exp-cost').value);
                    if (!item || isNaN(cost) || !user) return;
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('expenses').add({
                        item, cost,
                        currency: document.getElementById('exp-currency').value,
                        payer: document.getElementById('exp-payer').value,
                        createdAt: Date.now()
                    });
                    document.getElementById('exp-item').value = '';
                    document.getElementById('exp-cost').value = '';
                };

                window.deleteItem = async (coll, id) => {
                    if (!confirm('Á¢∫ÂÆöÂà™Èô§Ôºü')) return;
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection(coll).doc(id).delete();
                };

                window.toggleGemini = (open) => {
                    const modal = document.getElementById('gemini-modal');
                    if (open) modal.classList.add('open');
                    else modal.classList.remove('open');
                };

                window.askGemini = async (q = null) => {
                    const input = document.getElementById('gemini-input');
                    const text = q || input.value.trim();
                    if (!text) return;
                    window.toggleGemini(true);
                    input.value = '';
                    const chat = document.getElementById('gemini-chat');
                    chat.innerHTML += `<div class="text-right mb-2"><span class="bg-olive-600 bg-[#6B705C] text-white p-2 rounded-lg inline-block text-xs">${text}</span></div>`;
                    
                    try {
                        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: text }] }] })
                        });
                        const data = await res.json();
                        const reply = data.candidates[0].content.parts[0].text;
                        chat.innerHTML += `<div class="text-left mb-2"><span class="bg-white border p-2 rounded-lg inline-block text-xs shadow-sm">${reply.replace(/\n/g, '<br>')}</span></div>`;
                        chat.scrollTop = chat.scrollHeight;
                    } catch (e) { console.error(e); }
                };

            } catch (err) {
                console.error("Initialization Error:", err);
            }
        };

        function startSync() {
            const root = db.collection('artifacts').doc(appId).collection('public').doc('data');
            
            root.collection('itinerary').onSnapshot(s => {
                const items = s.docs.map(d => ({id: d.id, ...d.data()}));
                document.getElementById('it-list').innerHTML = items.sort((a,b)=>a.day.localeCompare(b.day)).map(i => `
                    <div class="app-card p-4 flex justify-between items-center">
                        <div>
                            <div class="text-[10px] font-bold text-gray-400">${i.day} ${i.time}</div>
                            <div class="font-bold text-sm">${i.activity}</div>
                        </div>
                        <button onclick="window.deleteItem('itinerary', '${i.id}')" class="text-gray-300">‚úï</button>
                    </div>
                `).join('');
            });

            root.collection('expenses').onSnapshot(s => {
                const items = s.docs.map(d => ({id: d.id, ...d.data()}));
                let total = 0;
                items.forEach(i => total += (i.cost * (rates[i.currency] || 1)));
                document.getElementById('total-amt').innerText = '‡∏ø ' + Math.round(total).toLocaleString();
                document.getElementById('exp-list').innerHTML = items.map(i => `
                    <div class="app-card p-3 flex justify-between items-center">
                        <div class="text-xs">
                            <div class="font-bold">${i.item}</div>
                            <div class="text-gray-400">${i.payer === 'tina' ? 'Tina' : 'Darren'} ‚Ä¢ ${i.currency} ${i.cost}</div>
                        </div>
                        <button onclick="window.deleteItem('expenses', '${i.id}')" class="text-gray-300">‚úï</button>
                    </div>
                `).join('');
            });
        }
    </script>
</head>
<body class="pb-24">
    <div id="loading-screen" class="loading-overlay">
        <div class="text-2xl animate-bounce">üáπüá≠</div>
        <div class="text-xs font-bold text-gray-400 mt-4">Ê≠£Âú®ËºâÂÖ• Darren & Tina ÁöÑÂ∞àÂ±¨ App...</div>
    </div>

    <header class="p-8 text-center bg-white border-b border-gray-100">
        <div class="text-[10px] font-black tracking-[0.3em] text-[#F8AD9D] mb-2 uppercase">Honeymoon Trip 2026</div>
        <h1 class="couple-name">DARREN & TINA</h1>
    </header>

    <main class="p-4 max-w-md mx-auto">
        <!-- Ë°åÁ®ãÂàÜÈ†Å -->
        <div id="content-itinerary" class="tab-content">
            <div class="app-card p-4 bg-white/50 border-2 border-dashed border-gray-200">
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <input type="text" id="it-day" placeholder="Day 1" class="p-2 text-xs rounded border">
                    <input type="time" id="it-time" class="p-2 text-xs rounded border">
                </div>
                <div class="flex gap-2 mb-2">
                    <select id="it-type" class="p-2 text-xs rounded border w-1/3">
                        <option value="view">ÊôØÈªû</option>
                        <option value="food">ÁæéÈ£ü</option>
                    </select>
                    <input type="text" id="it-activity" placeholder="ÂéªÂì™Ë£°Áé©Ôºü" class="p-2 text-xs rounded border w-2/3">
                </div>
                <button onclick="window.addItinerary()" class="w-full bg-[#4A4E40] text-white py-2 rounded-lg text-xs font-bold">Âä†ÂÖ•Ë°åÁ®ã</button>
            </div>
            <div id="it-list" class="space-y-3"></div>
        </div>

        <!-- Â∏≥ÁõÆÂàÜÈ†Å -->
        <div id="content-budget" class="tab-content hidden">
            <div class="app-card bg-[#6B705C] p-6 text-white text-center mb-4">
                <div class="text-[10px] opacity-70 uppercase mb-1">Total Spending (THB)</div>
                <div id="total-amt" class="text-3xl font-black italic">‡∏ø 0</div>
            </div>
            <div class="app-card p-4 space-y-3 mb-4">
                <input type="text" id="exp-item" placeholder="ÂìÅÈ†ÖÂêçÁ®±" class="w-full p-2 text-xs border rounded">
                <div class="flex gap-2">
                    <select id="exp-currency" class="p-2 text-xs border rounded w-1/3">
                        <option value="THB">THB</option>
                        <option value="TWD">TWD</option>
                        <option value="USD">USD</option>
                    </select>
                    <input type="number" id="exp-cost" placeholder="ÈáëÈ°ç" class="p-2 text-xs border rounded w-2/3">
                </div>
                <select id="exp-payer" class="w-full p-2 text-xs border rounded">
                    <option value="tina">Tina ‰ªòÊ¨æ</option>
                    <option value="darren">Darren ‰ªòÊ¨æ</option>
                </select>
                <button onclick="window.addExpense()" class="w-full bg-black text-white py-2 rounded-lg text-xs font-bold">Ë®òÂ∏≥</button>
            </div>
            <div id="exp-list" class="space-y-2"></div>
        </div>

        <!-- ÂÖ∂‰ªñÂàÜÈ†ÅÈ†êÁïô... -->
    </main>

    <!-- AI Âä©ÁêÜË¶ñÁ™ó -->
    <div id="gemini-modal" onclick="if(event.target===this) window.toggleGemini(false)">
        <div id="gemini-panel" onclick="event.stopPropagation()">
            <div class="p-5 flex flex-col h-full">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-sm">‚ú® ËúúÊúàÂä©Êâã</h3>
                    <button onclick="window.toggleGemini(false)" class="text-gray-300">‚úï</button>
                </div>
                <div id="gemini-chat" class="flex-1 overflow-y-auto mb-4 border rounded-xl p-3 bg-white"></div>
                <div class="flex gap-2">
                    <input type="text" id="gemini-input" placeholder="ÂïèÂïèÊé®Ëñ¶Ë°åÁ®ã..." class="flex-1 p-2 text-xs border rounded-lg">
                    <button onclick="window.askGemini()" class="bg-[#6B705C] text-white px-4 rounded-lg text-xs">ÁôºÈÄÅ</button>
                </div>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <div onclick="window.switchTab('itinerary')" id="btn-itinerary" class="nav-btn">üó∫Ô∏è</div>
        <div onclick="window.switchTab('budget')" id="btn-budget" class="nav-btn" style="opacity: 0.3;">üí∞</div>
        <div onclick="window.toggleGemini(true)" class="nav-btn">‚ú®</div>
    </nav>
</body>
</html>
