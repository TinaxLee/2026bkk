<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Darren & Tina 2026</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700;900&family=Montserrat:wght@400;700&family=Playfair+Display:ital,wght@0,700;1,700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --morandi-olive: #6B705C;
            --morandi-beige: #B7B7A4;
            --morandi-gold: #DDB892;
            --morandi-text: #4A4E40;
            --bg-light: #F8F7F2;
            --heart-pink: #F8AD9D;
        }

        body { 
            font-family: 'Montserrat', 'Noto Sans TC', sans-serif; 
            background-color: var(--bg-light); 
            color: var(--morandi-text); 
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            padding-bottom: 100px; /* Space for bottom nav */
        }

        /* éš±è—æ²è»¸ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .heart-text { 
            color: var(--heart-pink); 
            font-size: 0.75rem; 
            letter-spacing: 0.5em; 
            font-weight: 800; 
            margin-bottom: 0.5rem; 
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .couple-name { 
            font-family: 'Playfair Display', serif; 
            font-size: 2.2rem; 
            line-height: 1.1; 
            font-weight: 700; 
            color: #2D3128; 
            letter-spacing: 0.05em;
            margin: 0.5rem 0; 
        }
        .ampersand { font-family: sans-serif !important; font-weight: 400; margin: 0 4px; }
        
        .main-header {
            background: white;
            padding: 2.5rem 1rem 1.5rem;
            text-align: center;
            border-bottom: 1px solid rgba(0,0,0,0.03);
        }

        .app-card {
            background: white;
            border-radius: 1.2rem;
            box-shadow: 0 4px 12px -5px rgba(0,0,0,0.05);
            border: 1px solid rgba(255,255,255,0.8);
            overflow: hidden;
        }

        .bottom-nav {
            background: rgba(74, 78, 64, 0.95);
            backdrop-filter: blur(15px);
            position: fixed;
            bottom: 25px; left: 15px; right: 15px;
            border-radius: 2rem;
            height: 60px;
            z-index: 1000;
            display: flex; justify-content: space-around; align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .nav-btn { font-size: 1.1rem; cursor: pointer; transition: opacity 0.2s; padding: 10px; }
        .btn-press:active { transform: scale(0.95); }

        #gemini-modal {
            position: fixed; inset: 0; z-index: 2000;
            background: rgba(0,0,0,0.3);
            visibility: hidden; opacity: 0; transition: opacity 0.3s ease;
        }
        #gemini-modal.open { visibility: visible; opacity: 1; }
        #gemini-panel {
            position: absolute; bottom: 0; left: 0; right: 0;
            height: 85%; background: #F8F7F2; border-radius: 2rem 2rem 0 0;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0, 0, 0.2, 1);
        }
        #gemini-modal.open #gemini-panel { transform: translateY(0); }

        .tag { font-size: 10px; font-weight: 900; padding: 2px 8px; border-radius: 6px; display: inline-block; }
        .tag-type { background: #F3F4F6; color: #4B5563; border: 1px solid #E5E7EB; }

        input, select, textarea { font-size: 16px !important; } 

        .filter-chip {
            padding: 10px 14px; border-radius: 1.2rem; font-size: 10px; font-weight: 700;
            background: white; border: 1px solid #E5E7EB; color: #9CA3AF; transition: all 0.2s;
            text-align: left; min-width: 110px;
        }
        .filter-chip.active { background: #6B705C; border-color: #6B705C; color: white; }
        
        .expand-panel { display: none; margin-top: 10px; }
        .expand-panel.active { display: block; }

        .flight-path { position: relative; height: 1px; background: #E5E7EB; flex: 1; margin: 0 10px; }
        .flight-path::after { content: 'âœˆï¸'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 10px; }

        .weather-card {
            background: linear-gradient(135deg, #8E9775 0%, #6B705C 100%);
            color: white; border-radius: 1.2rem; padding: 1.2rem; margin-bottom: 1.5rem;
            position: relative; overflow: hidden;
        }

        /* Action Link Button Style */
        .action-link {
            font-size: 10px; font-weight: 800; color: #8E9775;
            padding: 6px 12px; border: 1.5px solid #E5E7EB; border-radius: 20px;
            display: inline-flex; align-items: center; gap: 4px;
            background: white; transition: all 0.2s;
            cursor: pointer;
            text-decoration: none; /* For <a> tags */
            line-height: 1.2;
        }
        .action-link:active { background: #f0f0f0; transform: scale(0.98); }
        .ai-btn { border-color: #DDB892; color: #b08d55; }

        .converter-box {
            background: #f1f3ef;
            border-radius: 1rem;
            padding: 1rem;
            border: 1px dashed #B7B7A4;
        }

        .thinking-dots::after {
            content: '.';
            animation: dots 1.5s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; }
        }

        /* Day Tabs Styling */
        .day-tab {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-width: 65px; height: 75px;
            background: white; border: 1px solid #E5E7EB; border-radius: 12px;
            margin-right: 8px; transition: all 0.3s;
            flex-shrink: 0; /* ç¦æ­¢è®Šå½¢ */
            cursor: pointer;
        }
        .day-tab.active {
            background: #6B705C; border-color: #6B705C; color: white; box-shadow: 0 4px 10px rgba(107, 112, 92, 0.3);
        }
        .day-tab-num { font-size: 12px; font-weight: 900; }
        .day-tab-date { font-size: 9px; margin-top: 4px; opacity: 0.8; font-weight: 600; }
        
        /* Timeline styling */
        .timeline-item { border-left: 3px solid #E5E7EB; margin-left: 10px; padding-left: 15px; position: relative; }
        .timeline-item::before {
            content: ''; position: absolute; left: -6px; top: 15px; width: 9px; height: 9px; border-radius: 50%; background: #E5E7EB; border: 2px solid white;
        }
        .timeline-food { border-left-color: #F8AD9D; }
        .timeline-food::before { background: #F8AD9D; }
        .timeline-view { border-left-color: #8E9775; }
        .timeline-view::before { background: #8E9775; }
        .timeline-shop { border-left-color: #DDB892; }
        .timeline-shop::before { background: #DDB892; }
        .timeline-note { border-left-color: #A5A58D; }
        .timeline-note::before { background: #A5A58D; }
        /* New Categories */
        .timeline-massage { border-left-color: #B5838D; }
        .timeline-massage::before { background: #B5838D; }
        .timeline-play { border-left-color: #CB997E; }
        .timeline-play::before { background: #CB997E; }

        /* Packing Filter Tabs */
        .pack-filter-btn {
            width: 32px; height: 32px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .pack-filter-btn.active {
            background: #6B705C; border-color: #6B705C; color: white; transform: scale(1.1);
        }
        .pack-filter-btn-tina.active { background: #F8AD9D; border-color: #F8AD9D; }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, collection, addDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBxcDDn80ScpW35TdJdeXOAkfJbHM0DyD0",
            authDomain: "honeymoon-2026.firebaseapp.com",
            projectId: "honeymoon-2026",
            storageBucket: "honeymoon-2026.firebasestorage.app",
            messagingSenderId: "639168649822",
            appId: "1:639168649822:web:20399eff7d34144277f2cf"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = "honeymoon-2026";
        
        let currentUser = null;
        let allExpenses = []; 
        let currentPayerFilter = 'all'; 
        let currentDayFilter = 'Day 1'; 
        let itineraryData = []; 
        let dayDates = {}; 
        let packingData = []; // Store raw packing data
        
        // Default packing filters
        let packFilters = { tina: 'cloth', darren: 'cloth' };
        
        const packCategories = [
            { id: 'cloth', icon: 'ğŸ‘”', label: 'è¡£ç‰©' },
            { id: 'wash', icon: 'ğŸ§¼', label: 'ç›¥æ´—' },
            { id: 'tech', icon: 'ğŸ“±', label: '3C' },
            { id: 'med', icon: 'ğŸ’Š', label: 'è—¥å“' },
            { id: 'doc', icon: 'ğŸ“„', label: 'æ–‡ä»¶' },
            { id: 'other', icon: 'ğŸ’', label: 'å…¶ä»–' }
        ];

        const ratesToTHB = { 'THB': 1, 'TWD': 1.05, 'USD': 35.5 };
        const thbToTWD = 0.95; 

        onAuthStateChanged(auth, async (user) => { 
            if (user) { 
                currentUser = user; 
                startSyncing(); 
            } else { 
                await signInAnonymously(auth); 
            } 
        });

        const getColl = (n) => collection(db, 'artifacts', appId, 'public', 'data', n);

        function startSyncing() {
            // Itinerary
            onSnapshot(getColl('itinerary'), (s) => {
                itineraryData = s.docs.map(d => ({id: d.id, ...d.data()}));
                renderItinerary();
            });
            // Trip Config (Dates)
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'dates'), (docSnap) => {
                if (docSnap.exists()) {
                    dayDates = docSnap.data();
                    renderDayTabs(); // Re-render tabs with dates
                }
            });
            // Packing
            onSnapshot(getColl('packing'), (s) => {
                packingData = s.docs.map(d => ({id: d.id, ...d.data()}));
                renderPacking(); // Re-render with new data
            });
            
            onSnapshot(getColl('expenses'), (s) => {
                allExpenses = s.docs.map(d => ({id: d.id, ...d.data()}));
                renderExpenses();
            });
            onSnapshot(getColl('flights'), (s) => renderFlights(s.docs.map(d => ({id: d.id, ...d.data()}))));
            onSnapshot(getColl('hotels'), (s) => renderHotels(s.docs.map(d => ({id: d.id, ...d.data()}))));
        }

        // --- Render Day Tabs ---
        window.renderDayTabs = () => {
            const container = document.getElementById('day-tabs-container');
            let html = '';
            for (let i = 1; i <= 7; i++) {
                const dayStr = `Day ${i}`;
                const dateStr = dayDates[dayStr] || ''; 
                const isActive = currentDayFilter === dayStr;
                
                let dateDisplay = dateStr ? dateStr : 'æ—¥æœŸ';
                
                html += `
                <div onclick="window.setDayFilter('${dayStr}')" class="day-tab ${isActive ? 'active' : ''}">
                    <div class="day-tab-num">${dayStr}</div>
                    ${isActive 
                        ? `<input type="text" value="${dateStr}" onclick="event.stopPropagation()" onchange="window.saveDate('${dayStr}', this.value)" placeholder="10/20" class="bg-white/20 text-center w-10 text-[9px] rounded text-white font-bold outline-none placeholder-white/50" style="background:rgba(255,255,255,0.2);">`
                        : `<div class="day-tab-date text-[9px]">${dateDisplay}</div>`
                    }
                </div>`;
            }
            container.innerHTML = html;
        };

        window.setDayFilter = (day) => {
            currentDayFilter = day;
            renderDayTabs(); // Update active state
            renderItinerary(); // Filter list
            document.getElementById('it-day').value = day;
        };

        window.saveDate = async (day, dateVal) => {
            if(!currentUser) return;
            const configRef = doc(db, 'artifacts', appId, 'public', 'data', 'config', 'dates');
            await setDoc(configRef, { [day]: dateVal }, { merge: true });
        };

        // --- Render Itinerary with Filter ---
        function renderItinerary() {
            const list = document.getElementById('it-list');
            const filtered = itineraryData.filter(item => item.day === currentDayFilter);
            const sorted = filtered.sort((a,b) => a.time.localeCompare(b.time));
            
            if (sorted.length === 0) {
                list.innerHTML = `<div class="text-center text-gray-400 text-xs py-10 font-bold">é€™å¤©é‚„æ²’æœ‰è¡Œç¨‹å–” ğŸ’¤</div>`;
                return;
            }

            list.innerHTML = sorted.map(item => {
                let typeClass = '';
                let typeLabel = '';
                let aiButton = '';

                const safeText = item.activity.replace(/'/g, "\\'"); 
                const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.activity)}`;

                switch(item.type) {
                    case 'food': 
                        typeClass = 'timeline-food'; typeLabel = 'ğŸ´ ç¾é£Ÿ'; 
                        aiButton = `<button onclick="window.askGemini('è«‹æ¨è–¦ ${safeText} çš„å¿…é»èœå–®èˆ‡ç‰¹è‰²ç¾é£Ÿ ğŸ¤')" class="action-link ai-btn">å¿…é»èœå–® ğŸ¤</button>`;
                        break;
                    case 'shop': 
                        typeClass = 'timeline-shop'; typeLabel = 'ğŸ›ï¸ è³¼ç‰©'; 
                        aiButton = `<button onclick="window.askGemini('åœ¨ ${safeText} æœ‰ä»€éº¼å¿…è²·çš„ä¼´æ‰‹ç¦®æˆ–æ¨è–¦å“ç‰Œï¼ŸğŸ')" class="action-link ai-btn">å¿…è²·ä¼´æ‰‹ç¦® ğŸ</button>`;
                        break;
                    case 'view': typeClass = 'timeline-view'; typeLabel = 'ğŸ“¸ æ™¯é»'; break;
                    case 'massage': 
                        typeClass = 'timeline-massage'; typeLabel = 'ğŸ’† æŒ‰æ‘©'; 
                        aiButton = `<button onclick="window.askGemini('è«‹æ¨è–¦ ${safeText} é™„è¿‘çš„æŒ‰æ‘© SPA èˆ‡åƒ¹ä½è³‡è¨Š ğŸ’†')" class="action-link ai-btn">æŒ‰æ‘©æ¨è–¦ ğŸ’†</button>`;
                        break;
                    case 'play': 
                        typeClass = 'timeline-play'; typeLabel = 'ğŸ¢ ç©æ¨‚'; 
                        aiButton = `<button onclick="window.askGemini('è«‹ä»‹ç´¹ ${safeText} çš„å¥½ç©è¨­æ–½èˆ‡éŠç©æ”»ç•¥ ğŸ¢')" class="action-link ai-btn">æ€éº¼ç© ğŸ¢</button>`;
                        break;
                    case 'note': typeClass = 'timeline-note'; typeLabel = 'ğŸ“ å‚™è¨»'; break;
                    case 'alert': typeClass = 'timeline-food'; typeLabel = 'ğŸ”” æç¤º'; break;
                    default: typeClass = 'timeline-view'; typeLabel = 'ğŸ“ è¡Œç¨‹';
                }

                return `
                <div class="app-card p-4 flex flex-col gap-2 mb-3 ${typeClass} timeline-item relative">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <!-- UPDATED: text-xs -> text-sm for better balance -->
                                <span class="text-sm font-bold text-gray-400 uppercase tracking-widest">${item.time}</span>
                                <span class="tag tag-type">${typeLabel}</span>
                            </div>
                            <!-- Activity Title -->
                            <div class="font-black text-[#4A4E40] text-lg leading-tight">${item.activity}</div>
                            ${item.note ? `<div class="text-xs text-gray-500 font-bold mt-1">ğŸ“ ${item.note}</div>` : ''}
                        </div>
                        <button onclick="window.deleteItem('itinerary', '${item.id}')" class="text-gray-200 p-2 -mt-2 -mr-2">âœ•</button>
                    </div>
                    
                    ${item.type !== 'note' && item.type !== 'alert' ? `
                    <div class="flex flex-wrap gap-2 pt-2 mt-1 border-t border-gray-50/50">
                        <a href="${mapUrl}" target="_blank" class="action-link">ğŸ“ å°èˆª</a>
                        <button onclick="window.askGemini('è«‹å‘Šè¨´æˆ‘é—œæ–¼ ${safeText} çš„è©³ç´°æ—…éŠæ”»ç•¥ã€åƒè§€é‡é»èˆ‡æ³¨æ„äº‹é …')" class="action-link">ğŸ’¡ æ”»ç•¥</button>
                        ${aiButton}
                    </div>` : ''}
                </div>`;
            }).join('');
        }

        // --- Packing with Categories ---
        window.setPackFilter = (owner, cat) => {
            packFilters[owner] = cat;
            renderPacking();
        };

        function renderPacking() {
            const draw = (owner, containerId) => {
                const currentCat = packFilters[owner];
                const filteredItems = packingData.filter(i => i.owner === owner && i.category === currentCat);
                const activeColorClass = owner === 'tina' ? 'pack-filter-btn-tina' : '';

                // Generate Tabs HTML
                let tabsHtml = `<div class="flex overflow-x-auto gap-2 mb-3 no-scrollbar pb-1 px-1">`;
                packCategories.forEach(c => {
                    const isActive = c.id === currentCat;
                    tabsHtml += `<button onclick="window.setPackFilter('${owner}', '${c.id}')" class="pack-filter-btn ${activeColorClass} ${isActive ? 'active' : ''}">${c.icon}</button>`;
                });
                tabsHtml += `</div>`;

                // Generate List HTML
                const itemsHtml = filteredItems.length > 0 ? filteredItems.map(i => `
                    <div class="p-3 flex items-center gap-3 border-b border-gray-50 last:border-0">
                        <div onclick="window.togglePack('${i.id}', ${i.checked})" class="w-4 h-4 rounded border ${i.checked ? 'bg-[#6B705C] border-[#6B705C]' : 'border-gray-200'} cursor-pointer"></div>
                        <!-- Increased Item Name Font -->
                        <span class="flex-1 text-sm ${i.checked ? 'line-through text-gray-300' : 'font-bold text-[#4A4E40]'}">${i.item}</span>
                        <button onclick="window.deleteItem('packing', '${i.id}')" class="text-gray-200 text-lg leading-none">Ã—</button>
                    </div>`).join('') : `<div class="text-center text-gray-300 text-[10px] py-4 font-bold italic">æ­¤åˆ†é¡é‚„æ²’æœ‰ç‰©å“ ğŸ¦—</div>`;

                document.getElementById(containerId).innerHTML = tabsHtml + `<div class="bg-white rounded-xl shadow-sm border border-gray-100">${itemsHtml}</div>`;
            };

            draw('tina', 'pk-list-tina'); 
            draw('darren', 'pk-list-darren');
        }

        // --- Other Renders ---
        function renderFlights(items) {
            document.getElementById('flights-list').innerHTML = items.map(f => `
                <div class="app-card p-5 mb-3">
                    <div class="flex justify-between items-center mb-4">
                        <!-- Increased Flight Code Font -->
                        <span class="bg-[#6B705C] text-white text-xs px-2 py-0.5 rounded font-black">${f.code}</span>
                        <div class="flex gap-2">
                             <!-- Increased Seat Font -->
                             <span class="text-xs font-bold text-gray-400">Seat: ${f.seat || '--'}</span>
                             <button onclick="window.deleteItem('flights', '${f.id}')" class="text-gray-200 text-xs">âœ•</button>
                        </div>
                    </div>
                    <div class="flex items-center justify-between mb-3">
                        <div class="text-center flex-1">
                            <div class="text-2xl font-black text-[#2D3128]">${f.from}</div>
                            <div class="text-sm font-bold text-[#6B705C]">${f.depTime || '--:--'}</div>
                        </div>
                        <div class="flight-path"></div>
                        <div class="text-center flex-1">
                            <div class="text-2xl font-black text-[#2D3128]">${f.to}</div>
                            <div class="text-sm font-bold text-[#6B705C]">${f.arrTime || '--:--'}</div>
                        </div>
                    </div>
                    ${f.note ? `<div class="bg-gray-50 border border-gray-100 rounded-lg p-2 mt-2">
                        <div class="text-[10px] text-gray-400 font-bold uppercase tracking-wider mb-0.5">Note</div>
                        <div class="text-xs font-bold text-[#4A4E40]">${f.note}</div>
                    </div>` : ''}
                </div>`).join('');
        }

        function renderHotels(items) {
            document.getElementById('hotels-list').innerHTML = items.map(h => `
                <div class="app-card p-4 mb-3">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex-1">
                            <div class="text-base font-black text-[#4A4E40]">${h.name}</div>
                            <div class="text-xs text-gray-400 font-bold mt-1">æˆ¿è™Ÿ: ${h.room || '--'} | å…¥ä½: ${h.checkin || '--'}</div>
                        </div>
                        <button onclick="window.deleteItem('hotels', '${h.id}')" class="text-gray-200 text-xs pl-4 self-start">âœ•</button>
                    </div>
                    ${h.note ? `<div class="bg-gray-50 border border-gray-100 rounded-lg p-2 mt-1">
                        <div class="text-[10px] text-gray-400 font-bold uppercase tracking-wider mb-0.5">Note</div>
                        <div class="text-xs font-bold text-[#4A4E40]">${h.note}</div>
                    </div>` : ''}
                </div>`).join('');
        }

        function renderExpenses() {
            let totalsByPayer = { tina: {}, darren: {} };
            allExpenses.forEach(e => { 
                if(!totalsByPayer[e.payer]) totalsByPayer[e.payer] = {};
                if(!totalsByPayer[e.payer][e.currency]) totalsByPayer[e.payer][e.currency] = 0;
                totalsByPayer[e.payer][e.currency] += e.cost;
            });
            const formatPayerSummary = (p) => {
                let lines = [];
                for(let curr in totalsByPayer[p]) lines.push(`${curr} ${Math.round(totalsByPayer[p][curr]).toLocaleString()}`);
                return lines.length > 0 ? lines.join(' / ') : 'å°šæœªæ”¯å‡º';
            };
            document.getElementById('chip-tina-amt').innerText = formatPayerSummary('tina');
            document.getElementById('chip-darren-amt').innerText = formatPayerSummary('darren');
            const filtered = currentPayerFilter === 'all' ? allExpenses : allExpenses.filter(e => e.payer === currentPayerFilter);
            const totalSum = filtered.reduce((s, e) => s + (e.cost * (ratesToTHB[e.currency] || 1)), 0);
            document.getElementById('total-amount').innerText = 'à¸¿ ' + Math.round(totalSum).toLocaleString();
            document.getElementById('exp-list').innerHTML = filtered.map(exp => `
                <div class="app-card p-3 flex justify-between items-center mb-2 border-l-4 ${exp.payer==='tina'?'border-[#F8AD9D]':'border-[#6B705C]'}">
                    <div class="flex-1 pr-4">
                        <div class="text-xs font-bold text-[#4A4E40]">${exp.item}</div>
                        <div class="text-[9px] text-gray-400 mt-0.5 font-bold uppercase tracking-tighter">${exp.payer==='tina'?'Tina ğŸ’°':'Darren ğŸ’³'} â€¢ ${exp.currency} ${exp.cost.toLocaleString()}</div>
                    </div>
                    <div class="text-right"><div class="text-sm font-black text-[#2D3128]">à¸¿ ${Math.round(exp.cost * (ratesToTHB[exp.currency] || 1)).toLocaleString()}</div></div>
                    <button onclick="window.deleteItem('expenses', '${exp.id}')" class="text-gray-100 ml-3 text-[10px]">âœ•</button>
                </div>`).join('');
        }

        // --- Actions ---
        window.addItinerary = async () => {
            const act = document.getElementById('it-activity').value; if(!act || !currentUser) return;
            const dayVal = document.getElementById('it-day').value;
            const noteVal = document.getElementById('it-note').value; 
            const startTime = document.getElementById('it-time-start').value || '12:00';
            const endTime = document.getElementById('it-time-end').value;
            const timeVal = endTime ? `${startTime} - ${endTime}` : startTime;

            await addDoc(getColl('itinerary'), { 
                day: dayVal, time: timeVal, activity: act, note: noteVal, type: document.getElementById('it-type').value 
            });
            document.getElementById('it-activity').value = '';
            document.getElementById('it-time-end').value = '';
            document.getElementById('it-note').value = '';
            window.setDayFilter(dayVal);
        };

        window.addFlight = async () => {
            const code = document.getElementById('f-code').value; if (!code || !currentUser) return;
            const note = document.getElementById('f-note').value;
            await addDoc(getColl('flights'), { 
                code, 
                from: document.getElementById('f-from').value, 
                to: document.getElementById('f-to').value, 
                depTime: document.getElementById('f-depTime').value, 
                arrTime: document.getElementById('f-arrTime').value, 
                checkinTime: document.getElementById('f-checkinTime').value, 
                seat: document.getElementById('f-seat').value,
                note: note
            });
            document.getElementById('f-code').value = ''; 
            document.getElementById('f-note').value = '';
            window.toggleSection('flight');
        };

        window.addHotel = async () => {
            const name = document.getElementById('h-name').value; if (!name || !currentUser) return;
            const note = document.getElementById('h-note').value;
            await addDoc(getColl('hotels'), { 
                name, 
                room: document.getElementById('h-room').value, 
                checkin: document.getElementById('h-checkin').value,
                note: note
            });
            document.getElementById('h-name').value = ''; 
            document.getElementById('h-note').value = '';
            window.toggleSection('hotel');
        };

        window.addExpense = async () => {
            const itemInput = document.getElementById('exp-item');
            const costInput = document.getElementById('exp-cost');
            const item = itemInput.value.trim();
            const costRaw = costInput.value;
            const payer = document.getElementById('exp-payer').value;
            const currency = document.getElementById('exp-currency').value;
            if (!item || !costRaw || isNaN(parseFloat(costRaw)) || !currentUser) return;
            await addDoc(getColl('expenses'), { item, cost: parseFloat(costRaw), currency, payer, createdAt: Date.now() });
            itemInput.value = ''; costInput.value = '';
            document.getElementById('exchange-hint').innerText = '';
        };

        window.addPacking = async () => {
            const val = document.getElementById('pack-item').value; if(!val || !currentUser) return;
            const cat = document.getElementById('pack-category').value || 'other';
            const owner = document.getElementById('pack-owner').value;
            
            await addDoc(getColl('packing'), { item: val, owner: owner, checked: false, category: cat });
            
            // Auto switch filter to new category
            window.setPackFilter(owner, cat);
            document.getElementById('pack-item').value = '';
        };

        window.deleteItem = async (c, id) => { if(currentUser) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', c, id)); };
        window.togglePack = async (id, s) => { if(currentUser) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'packing', id), { checked: !s }); };

        window.askGemini = async (q = null) => {
            const input = document.getElementById('gemini-input');
            const chat = document.getElementById('gemini-chat');
            const query = q || input.value.trim(); if(!query) return;
            window.toggleGemini(true);
            if(!q) input.value = '';
            chat.innerHTML += `<div class="mb-4 text-right"><span class="inline-block bg-[#6B705C] text-white p-3 rounded-2xl text-sm font-bold shadow-sm">${query}</span></div>`;
            const thinkingId = 'think-' + Date.now();
            chat.innerHTML += `<div id="${thinkingId}" class="mb-4 text-left"><div class="inline-block bg-white p-3 rounded-2xl text-sm shadow-sm border text-gray-400 italic font-bold">åŠ©ç†æ€è€ƒä¸­<span class="thinking-dots"></span></div></div>`;
            chat.scrollTop = chat.scrollHeight;
            try {
                const apiKey = ""; // Runtime provides this
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: `ä½ æ˜¯èœœæœˆåŠ©ç†ã€‚è«‹ç”¨è¦ªåˆ‡æ´»æ½‘çš„èªæ°£å›è¦†ä»¥ä¸‹é—œæ–¼æ³°åœ‹èœœæœˆçš„è©¢å•ï¼š${query}` }] }] })
                });
                const data = await res.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "...";
                document.getElementById(thinkingId)?.remove();
                chat.innerHTML += `<div class="mb-4 text-left"><div class="inline-block bg-white p-4 rounded-2xl text-base shadow-sm border leading-7 text-[#4A4E40]">${text.replace(/\n/g, '<br>')}</div></div>`;
            } catch (e) { document.getElementById(thinkingId)?.remove(); }
            chat.scrollTop = chat.scrollHeight;
        };

        window.calcIndependentRate = () => {
            const val = parseFloat(document.getElementById('conv-input').value) || 0;
            const curr = document.getElementById('conv-curr').value;
            const res = document.getElementById('conv-res');
            if (curr === 'THB') {
                res.innerText = `å°å¹£ NT$ ${Math.round(val * thbToTWD).toLocaleString()}`;
            } else {
                res.innerText = `æ³°éŠ– à¸¿ ${Math.round(val * (ratesToTHB[curr] || 1)).toLocaleString()}`;
            }
        };

        window.updateExchangePreview = () => {
            const cost = parseFloat(document.getElementById('exp-cost').value) || 0;
            const curr = document.getElementById('exp-currency').value;
            const hint = document.getElementById('exchange-hint');
            hint.innerText = curr === 'THB' ? '' : `â‰ˆ à¸¿ ${Math.round(cost * (ratesToTHB[curr] || 1)).toLocaleString()}`;
        };
        
        window.getWeather = async () => {
            try {
                const url = "https://api.open-meteo.com/v1/forecast?latitude=13.75,7.88&longitude=100.50,98.39&current=temperature_2m,weather_code&timezone=Asia%2FBangkok";
                const res = await fetch(url);
                const data = await res.json();
                const bkkTemp = Math.round(data[0].current.temperature_2m);
                const hktTemp = Math.round(data[1].current.temperature_2m);
                document.getElementById('weather-display').innerHTML = `
                    <div class="text-lg font-black">æ›¼è°· ${bkkTemp}Â°C / æ™®å‰ ${hktTemp}Â°C</div>
                    <div class="text-[9px] mt-1 font-bold opacity-60">å³æ™‚æ°£æº«å·²æ›´æ–° â€¢ é»æ“ŠæŸ¥çœ‹ AI ç©¿æ­å»ºè­° âœ¨</div>`;
            } catch(e) { console.log("Weather error", e); }
        };

        window.setPayerFilter = (p) => { currentPayerFilter = p; document.querySelectorAll('.filter-chip').forEach(el => el.classList.toggle('active', el.id === 'chip-'+p)); renderExpenses(); };
        window.toggleSection = (id) => { document.getElementById(id+'-grid').classList.toggle('active'); };
        window.toggleGemini = (f = false) => { const m = document.getElementById('gemini-modal'); if(f) m.classList.add('open'); else m.classList.toggle('open'); };
        window.switchTab = (id) => {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById('content-'+id).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.add('opacity-30'));
            document.getElementById('btn-'+id).classList.remove('opacity-30');
        };
        window.clearGemini = () => { document.getElementById('gemini-chat').innerHTML = ''; };

        window.switchTab('itinerary');
        window.renderDayTabs(); 
        window.getWeather(); 
    </script>
</head>
<body>
    <header class="main-header">
        <div class="heart-text"><span>â™¥</span> SWEET GETAWAY <span>â™¥</span></div>
        <h1 class="couple-name">DARREN <span class="ampersand">&</span> TINA</h1>
        <p class="text-[9px] font-black text-[#8E9775] mt-1 tracking-[0.2em] uppercase">2026 Bangkok Phuket ğŸ‡¹ğŸ‡­âœˆï¸</p>
    </header>

    <main class="max-w-md mx-auto p-4">
        
        <!-- è¡Œç¨‹è¡¨ -->
        <div id="content-itinerary" class="tab-content">
            <div class="weather-card flex justify-between items-center shadow-lg" onclick="window.askGemini('å¹«æˆ‘æŸ¥æ›¼è°·ä»Šå¤©çš„å³æ™‚å¤©æ°£å‹•æ…‹ï¼Œä¸¦çµ¦ Darren & Tina ç©¿æ­å»ºè­°ã€‚')">
                <div>
                    <div class="text-[10px] font-bold opacity-80 uppercase tracking-widest mb-1">Current Weather</div>
                    <div id="weather-display">
                        <div class="text-lg font-black">æ›¼è°· --Â°C / æ™®å‰ --Â°C</div>
                        <div class="text-[9px] mt-1 font-bold opacity-60">æ­£åœ¨æŠ“å–å¤©æ°£è³‡è¨Š...</div>
                    </div>
                </div>
                <div class="text-3xl">â˜€ï¸</div>
            </div>

            <div id="day-tabs-container" class="flex overflow-x-auto no-scrollbar pb-2 mb-2"></div>

            <div class="app-card p-4 bg-white/80 mb-4 border-dashed border-2 border-gray-200">
                <div class="flex gap-2 mb-2">
                    <select id="it-day" class="w-1/4 bg-gray-50 p-2 rounded-lg text-xs font-bold outline-none border border-transparent focus:border-[#6B705C]">
                        <option value="Day 1">Day 1</option>
                        <option value="Day 2">Day 2</option>
                        <option value="Day 3">Day 3</option>
                        <option value="Day 4">Day 4</option>
                        <option value="Day 5">Day 5</option>
                        <option value="Day 6">Day 6</option>
                        <option value="Day 7">Day 7</option>
                    </select>
                    <div class="flex-1 flex gap-1 items-center bg-gray-50 rounded-lg px-2 border border-transparent focus-within:border-[#6B705C]">
                        <input type="time" id="it-time-start" class="w-full bg-transparent p-1 text-xs outline-none font-bold text-center text-[#4A4E40]" aria-label="é–‹å§‹æ™‚é–“">
                        <span class="text-gray-400 font-bold text-xs">~</span>
                        <input type="time" id="it-time-end" class="w-full bg-transparent p-1 text-xs outline-none font-bold text-center text-gray-500" aria-label="çµæŸæ™‚é–“ (é¸å¡«)">
                    </div>
                </div>
                <div class="flex gap-2 mb-2">
                    <select id="it-type" class="w-1/3 bg-gray-50 p-2 rounded-lg text-xs font-bold outline-none">
                        <option value="view">ğŸ“¸ æ™¯é»</option>
                        <option value="food">ğŸ´ ç¾é£Ÿ</option>
                        <option value="shop">ğŸ›ï¸ è³¼ç‰©</option>
                        <option value="massage">ğŸ’† æŒ‰æ‘©</option>
                        <option value="play">ğŸ¢ ç©æ¨‚</option>
                        <option value="note">ğŸ“ å‚™è¨»</option>
                        <option value="alert">ğŸ”” æç¤º</option>
                    </select>
                    <input type="text" id="it-activity" placeholder="è¡Œç¨‹åç¨±..." class="w-2/3 bg-gray-50 p-2 rounded-lg text-xs outline-none">
                </div>
                <div class="mb-2">
                    <input type="text" id="it-note" placeholder="å‚™è¨» (ä¾‹å¦‚: è¨˜å¾—è¨‚ä½ã€å¿…é»èƒèŸ¹å’–å“©)..." class="w-full bg-gray-50 p-2 rounded-lg text-xs outline-none">
                </div>
                <button onclick="window.addItinerary()" class="bg-[#4A4E40] text-white w-full py-2.5 rounded-lg font-bold text-xs">åŠ å…¥è¡Œç¨‹</button>
            </div>
            
            <div id="it-list"></div>
        </div>

        <!-- äº¤é€šä½å®¿ (Core) -->
        <div id="content-core" class="tab-content hidden">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-sm font-black text-[#4A4E40]">èˆªç­è³‡è¨Š âœˆï¸</h3>
                <button onclick="window.toggleSection('flight')" class="text-[10px] bg-[#6B705C] text-white px-3 py-1 rounded-full font-bold">ï¼‹æ–°å¢</button>
            </div>
            <div id="flight-grid" class="expand-panel app-card p-4 mb-4 bg-gray-50">
                <input type="text" id="f-code" placeholder="èˆªç­è™Ÿ (å¦‚ TG635)" class="w-full p-2 text-xs rounded-lg border mb-2 font-bold">
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <input type="text" id="f-from" placeholder="å‡ºç™¼åœ°" class="p-2 text-xs rounded-lg border">
                    <input type="text" id="f-to" placeholder="ç›®çš„åœ°" class="p-2 text-xs rounded-lg border">
                </div>
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <input type="time" id="f-checkinTime" class="p-2 text-xs rounded-lg border">
                    <input type="text" id="f-seat" placeholder="åº§ä½" class="p-2 text-xs rounded-lg border">
                </div>
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <input type="time" id="f-depTime" class="p-2 text-xs rounded-lg border">
                    <input type="time" id="f-arrTime" class="p-2 text-xs rounded-lg border">
                </div>
                <input type="text" id="f-note" placeholder="å‚™è¨» (ä¾‹å¦‚: éœ€ææ—©åˆ°æ©Ÿå ´)..." class="w-full p-2 text-xs rounded-lg border mb-2">
                <button onclick="window.addFlight()" class="w-full bg-[#6B705C] text-white py-2 rounded-lg text-xs font-bold">å„²å­˜èˆªç­</button>
            </div>
            <div id="flights-list"></div>
            
            <div class="flex justify-between items-center mt-6 mb-3">
                <h3 class="text-sm font-black text-[#4A4E40]">å…¥ä½é£¯åº— ğŸ¨</h3>
                <button onclick="window.toggleSection('hotel')" class="text-[10px] bg-[#DDB892] text-white px-3 py-1 rounded-full font-bold">ï¼‹æ–°å¢</button>
            </div>
            <div id="hotel-grid" class="expand-panel app-card p-4 mb-4 bg-gray-50">
                <input type="text" id="h-name" placeholder="é£¯åº—åç¨±" class="w-full p-2 text-xs rounded-lg border mb-2 font-bold">
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <input type="text" id="h-room" placeholder="æˆ¿è™Ÿ" class="p-2 text-xs rounded-lg border">
                    <input type="date" id="h-checkin" class="p-2 text-xs rounded-lg border">
                </div>
                <input type="text" id="h-note" placeholder="å‚™è¨» (ä¾‹å¦‚: éœ€ä»˜æŠ¼é‡‘)..." class="w-full p-2 text-xs rounded-lg border mb-2">
                <button onclick="window.addHotel()" class="w-full bg-[#DDB892] text-white py-2 rounded-lg text-xs font-bold">å„²å­˜é£¯åº—</button>
            </div>
            <div id="hotels-list"></div>
        </div>

        <!-- æ”¯å‡ºçµ±è¨ˆ (Budget) -->
        <div id="content-budget" class="tab-content hidden">
            <div class="converter-box mb-6">
                <p class="text-[10px] font-black text-[#6B705C] mb-2 uppercase tracking-widest">âš¡ å¿«é€ŸåŒ¯ç‡æ›ç®—</p>
                <div class="flex gap-2 items-center">
                    <input type="number" id="conv-input" placeholder="è¼¸å…¥é‡‘é¡" oninput="window.calcIndependentRate()" class="flex-1 bg-white p-2 rounded-lg text-xs outline-none font-bold">
                    <select id="conv-curr" onchange="window.calcIndependentRate()" class="bg-white p-2 rounded-lg text-xs font-black outline-none">
                        <option value="TWD">TWD å°å¹£</option>
                        <option value="USD">USD ç¾é‡‘</option>
                        <option value="THB">THB æ³°éŠ–</option>
                    </select>
                </div>
                <div id="conv-res" class="mt-2 text-sm font-black text-[#4A4E40] italic">æ³°éŠ– à¸¿ 0</div>
            </div>

            <div class="app-card bg-[#6B705C] p-5 text-white mb-4 relative overflow-hidden">
                <p class="text-[9px] opacity-70 uppercase font-bold tracking-widest">Honeymoon Total (THB)</p>
                <h2 id="total-amount" class="text-3xl font-black italic">à¸¿ 0</h2>
                <div class="absolute right-[-10px] bottom-[-10px] text-6xl opacity-10">ğŸ’°</div>
            </div>
            
            <div class="flex gap-3 mb-4 overflow-x-auto pb-1 no-scrollbar">
                <button onclick="window.setPayerFilter('all')" id="chip-all" class="filter-chip active flex-shrink-0">å…¨éƒ¨æ”¯å‡º</button>
                <button onclick="window.setPayerFilter('tina')" id="chip-tina" class="filter-chip flex-shrink-0">
                    <div class="font-black">Tina</div>
                    <div id="chip-tina-amt" class="text-[8px] font-bold mt-1 opacity-70"></div>
                </button>
                <button onclick="window.setPayerFilter('darren')" id="chip-darren" class="filter-chip flex-shrink-0">
                    <div class="font-black">Darren</div>
                    <div id="chip-darren-amt" class="text-[8px] font-bold mt-1 opacity-70"></div>
                </button>
            </div>

            <div class="app-card p-4 space-y-3">
                <div class="flex flex-col gap-2">
                    <input type="text" id="exp-item" placeholder="é€™æ˜¯èŠ±äº†ä»€éº¼ï¼Ÿ" class="w-full bg-gray-50 p-2.5 rounded-xl text-xs outline-none">
                    <select id="exp-payer" class="w-full bg-gray-100 p-2.5 rounded-xl text-[10px] font-black">
                        <option value="tina">Tina éœ¸æ°£è²·å–® ğŸ’°</option>
                        <option value="darren">Darren è­·å¦»ç¥åˆ· ğŸ’³</option>
                    </select>
                </div>
                <div class="flex gap-2 items-center">
                    <select id="exp-currency" onchange="window.updateExchangePreview()" class="bg-gray-50 p-2.5 rounded-xl text-xs font-bold outline-none"><option value="THB">THB</option><option value="TWD">TWD</option><option value="USD">USD</option></select>
                    <div class="flex-1 relative">
                        <input type="number" id="exp-cost" oninput="window.updateExchangePreview()" placeholder="é‡‘é¡" class="w-full bg-gray-50 p-2.5 rounded-xl text-xs outline-none font-bold">
                        <div id="exchange-hint" class="absolute right-3 top-1/2 -translate-y-1/2 text-[9px] text-gray-400 font-bold italic"></div>
                    </div>
                </div>
                <button onclick="window.addExpense()" class="w-full bg-[#2D3128] text-white py-3 rounded-xl text-xs font-black tracking-widest mt-2">æ–° å¢ è¨˜ å¸³</button>
            </div>
            <div id="exp-list" class="mt-4"></div>
        </div>

        <!-- è¡Œææ¸…å–® (Packing) -->
        <div id="content-packing" class="tab-content hidden">
            <div class="app-card p-4 mb-4">
                <div class="mb-2">
                    <select id="pack-category" class="w-full bg-gray-100 p-2 rounded-lg text-xs font-bold mb-2">
                        <option value="cloth">ğŸ‘” å€‹äººè¡£ç‰©</option>
                        <option value="wash">ğŸ§¼ å€‹äººç›¥æ´—</option>
                        <option value="tech">ğŸ“± 3C ç”¢å“</option>
                        <option value="med">ğŸ’Š å€‹äººè—¥å“</option>
                        <option value="doc">ğŸ“„ é‡è¦æ–‡ä»¶</option>
                        <option value="other">ğŸ’ å…¶ä»–ç‰©å“</option>
                    </select>
                </div>
                <div class="flex gap-2 mb-2">
                    <input type="text" id="pack-item" placeholder="ç‰©å“åç¨±..." class="flex-1 bg-gray-50 p-2 rounded-lg text-xs outline-none">
                    <select id="pack-owner" class="bg-gray-50 px-2 rounded-lg text-xs font-bold"><option value="tina">Tina</option><option value="darren">Darren</option></select>
                </div>
                <button onclick="window.addPacking()" class="bg-[#6B705C] text-white w-full py-2.5 rounded-lg font-bold text-xs">è¨˜ å¾— è¨˜ å¾— å¸¶ ï¼</button>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <p class="text-[10px] font-bold text-[#F8AD9D] mb-1 ml-1 uppercase">Tina's</p>
                    <div id="pk-list-tina" class="app-card min-h-[50px]"></div>
                </div>
                <div>
                    <p class="text-[10px] font-bold text-[#6B705C] mb-1 ml-1 uppercase">Darren's</p>
                    <div id="pk-list-darren" class="app-card min-h-[50px]"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- AI åŠ©ç† -->
    <div id="gemini-modal" onclick="if(event.target === this) window.toggleGemini()">
        <div id="gemini-panel" onclick="event.stopPropagation()">
            <div class="p-5 h-full flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-2">
                        <!-- Increased header size -->
                        <h3 class="font-black text-lg text-[#4A4E40]">âœ¨ èœœæœˆåŠ©ç†</h3>
                        <button onclick="window.clearGemini()" class="text-[10px] bg-gray-200 px-2 py-1 rounded-full text-gray-500 font-bold">æ¸…é™¤ç´€éŒ„</button>
                    </div>
                    <button onclick="window.toggleGemini()" class="text-2xl text-gray-300">âœ•</button>
                </div>
                <div id="gemini-chat" class="flex-1 overflow-y-auto mb-4 space-y-4 text-sm"></div>
                <div class="flex gap-2 p-2 bg-white rounded-2xl shadow-inner border">
                    <!-- Increased input size -->
                    <input type="text" id="gemini-input" placeholder="å•å•åŠ©ç†..." class="flex-1 p-3 text-base outline-none bg-transparent">
                    <button onclick="window.askGemini()" class="bg-[#6B705C] text-white px-5 rounded-xl text-sm font-bold">ç™¼é€</button>
                </div>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <div onclick="window.switchTab('core')" id="btn-core" class="nav-btn btn-press opacity-30">ğŸ›«</div>
        <div onclick="window.switchTab('itinerary')" id="btn-itinerary" class="nav-btn btn-press">ğŸ—ºï¸</div>
        <div onclick="window.switchTab('packing')" id="btn-packing" class="nav-btn btn-press opacity-30">ğŸ’</div>
        <div onclick="window.switchTab('budget')" id="btn-budget" class="nav-btn btn-press opacity-30">ğŸ’°</div>
        <div onclick="window.toggleGemini()" class="nav-btn btn-press">âœ¨</div>
    </nav>
</body>
</html>
